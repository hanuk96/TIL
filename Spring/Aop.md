# AOP
**핵심 기능**은 해당 객체가 제공하는 고유의 기능이다.

예를 들어서 `OrderService` 의 핵심 기능은 주문 로직이다.

**부가 기능**은 핵심 기능을 보조하기 위해 제공되는 기능이다.

예를 들어서 로그 추적 로직, 트랜잭션 기능이 있다. 이러한 부가 기능은 단독으로 사용되지 않고, 핵심 기능과 함께 사용된다.

## AspectJ 프레임워크

AOP의 대표적인 구현체로 AspectJ 프레임워크(https://www.eclipse.org/aspectj/)가 있다. 

물론 스프링도 AOP를 지원하지만 대부분 AspectJ의 문법을 차용하고, AspectJ가 제공하는 기능의 일부만 제공한다.

AspectJ 프레임워크는 스스로를 다음과 같이 설명한다. 
- 오류 검사 및 처리
- 동기화
- 성능 최적화(캐싱)
- 모니터링 및 로깅

그렇다면 AOP를 사용할 때 부가 기능 로직은 언제 실제 로직에 추가될 수 있을까?

- 컴파일 시점
- 클래스 로딩 시점
- 런타임 시점(프록시)

### 컴파일시점

`.java` 소스 코드를 컴파일러를 사용해서 `.class` 를 만드는 시점에 부가 기능 로직을 추가할 수 있다. 

이때는 JavaC 컴파일러가 아닌 AspectJ가 제공하는 특별한 컴파일러를 사용해야 한다.

참고로 이렇게 원본 로직에 부가 기능 로직이 추가되는 것을 위빙(Weaving)이라 한다.

<img width="800" alt="image" src="https://github.com/hanuk96/TIL/assets/12428689/24f13b06-34f9-4b69-b271-ef1ecf607119">

### 클래스 로딩 시점

자바를 실행하면 `.class` 파일을 JVM 내부의 클래스 로더에 보관한다. 

이때 중간에서 `.class` 파일을 조작한 다음 JVM에 올릴 수 있다.(Java Instrumentation)

수 많은 모니터링툴들이 이 방식을 사용한다.

<img width="800" alt="image" src="https://github.com/hanuk96/TIL/assets/12428689/2f0b4c86-050f-44bd-9860-534cc68e30d7">

### 런타임 시점

런타임 시점은 자바의 메인( `main` ) 메서드가 실행된 다음이다. 

프록시를 사용하기 때문에 AOP 기능에 일부 제약이 있다. 

하지만 특별한 컴파일러나, 자바를 실행할 때 복잡한 옵션과 클래스 로더 조작기를 설정하지 않아도 된다.

<img width="800" alt="image" src="https://github.com/hanuk96/TIL/assets/12428689/027256ec-933c-4331-808d-727b3a07bdbe">

**부가 기능이 적용되는 차이를 정리하면 다음과 같다.**

컴파일 시점: 실제 대상 코드에 Aspect를 통한 부가 기능 호출 코드가 포함된다. AspectJ 프레임워크를 직접 사용해야한다.

클래스 로딩 시점: 실제 대상 코드에 Aspect를 통한 부가 기능 호출 코드가 포함된다. AspectJ 프레임워크를 직접 사용해야한다.

런타임 시점: 실제 대상 코드는 그대로 유지된다. 프록시를 통해 부가 기능이 적용하는데 스프링 AOP는 이 방식을 사용한다.

## AOP 적용 위치

프록시 방식을 사용하는 스프링 AOP는 메서드 실행 지점에만 AOP를 적용할 수 있다.

프록시는 메서드 오버라이딩 개념으로 동작한다. 따라서 생성자나 static 메서드, 필드 값 접근에는 프록시 개념이 적용될 수 없다.

프록시를 사용하는 **스프링 AOP의 조인 포인트는 메서드 실행으로 제한**된다.

프록시 방식을 사용하는 스프링 AOP는 스프링 컨테이너가 관리할 수 있는 **스프링 빈에만 AOP를 적용**할 수 있다.

<img width="800" alt="image" src="https://github.com/hanuk96/TIL/assets/12428689/8b807414-9705-4fce-827d-fb9d289c218e">

### 위빙(Weaving)
포인트컷으로 결정한 타켓의 조인 포인트에 어드바이스를 적용하는 것 

위빙을 통해 핵심 기능 코드에 영향을 주지 않고 부가 기능을 추가 할 수 있음 

AOP 적용을 위해 애스펙트를 객체에 연결한 상태
- 컴파일 타임(AspectJ compiler)
- 클래스 로드 타임
- 런타임, 스프링 AOP는 런타임, 프록시 방식

### 조인 포인트(Join point)
어드바이스가 적용될 수 있는 위치, 메소드 실행, 생성자 호출, 필드 값 접근, static 메서드 접근 같은 프로그램 실행 중 지점

조인 포인트는 추상적인 개념이다. AOP를 적용할 수 있는 모든 지점이라 생각하면 된다.

스프링 AOP는 프록시 방식을 사용하므로 조인 포인트는 항상 메소드 실행 지점으로 제한된다.

### 어드바이스(Advice)
부가 기능

Around(주변), Before(전), After(후)와 같은 다양한 종류의 어드바이스가 있음 

### 포인트컷(Pointcut)
주로 AspectJ 표현식을 사용해서 지정

조인 포인트 중에서 어드바이스가 적용될 위치를 선별하는 기능

### 애스펙트(Aspect)
어드바이스 + 포인트컷을 모듈화 한 것으로 `@Aspect` 를 생각하면 됨

여러 어드바이스와 포인트 컷이 함께 존재

### 타켓(Target)
어드바이스를 받는 객체, 포인트컷으로 결정

### 어드바이저(Advisor)
하나의 어드바이스와 하나의 포인트 컷으로 구성됨

스프링 AOP에서만 사용되는 특별한 용어

### AOP 프록시
AOP 기능을 구현하기 위해 만든 프록시 객체로 스프링에서는 JDK 동적 프록시 또는 CGLIB 프록시이다.
